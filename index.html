<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <title>Изометрический город</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
        html,
        body {
            position: relative;
            margin: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #8f8e3c;
        }

        #city-holder {
            position: absolute;
            width: 100%;
            height: 100%;
        }

        #city {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        #city-buildings {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
        }

        #grid-container {
            position: absolute;
            transform-origin: 0 0;
            transform: rotateX(60deg) rotateZ(-45deg) scale(0.7) translate(-50%, -50%);
            perspective: 1000px;
            top: 50%;
            left: 50%;
            display: none;
        }

        .menu {
            position: absolute;
            width: 100px;
            height: 100px;
            background-color: hsla(0, 0%, 0%, 0.1);
            border-top-right-radius: 20px;
            border-bottom-right-radius: 20px;
            transition: 0.2s height ease-in-out;
            top: 50%;
            left: 0;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            gap: 5px;
            overflow: hidden;
            background-repeat: no-repeat;
            background-position: 50% 50%;
            background-image: url(img/edit.svg);
            background-size: 80px;
            padding: 10px;
            box-sizing: border-box;
        }

        .menu.expanded {
            height: 500px;
            background-color: hsla(0, 0%, 0%, 0.3);
            background-image: none;
        }

        .tool-btn {
            display: none;
            height: 80px;
            width: 100%;
            flex-shrink: 0;
            background-repeat: no-repeat;
            background-size: contain;
            background-position: 50% 50%;
        }

        #tools.expanded .tool-btn {
            display: flex;
        }

        .building {
            position: absolute;
            transform: translate(-50%, -100%);
            pointer-events: auto;
            user-select: none;
            pointer-events: none;
        }

        .building.dragging {
            opacity: 0.8;
            cursor: grabbing;
        }

        .building-base {
            position: absolute;
            transform: rotateX(60deg) rotateZ(-45deg) scale(0.7) translate(-50%, 50%);
            perspective: 1000px;
            pointer-events: all;
            left: 0;
            top: 0;
            /* background-color: hsla(0, 0%, 0%, 0.1); */
        }

        .building-image {
            position: absolute;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-repeat: no-repeat;
        }

        #grid {
            position: absolute;
            background-image:
                linear-gradient(rgba(0, 0, 0, 0.3) 2px, transparent 2px),
                linear-gradient(90deg, rgba(0, 0, 0, 0.3) 2px, transparent 2px);
            background-size: 100px 100px;
            transform: translate(-50%, -50%);
        }

        #close-tools {
            background-image: url(img/close.svg);
            position: absolute;
            top: auto;
            bottom: 10px;
        }

        #edit-building-tools {
            background-image: url(img/building-edit.svg);
            background-size: 80%;
        }

        #edit-building-tools.active {
            background-image: url(img/building-edit-active.svg);
        }

        #move-cam-tools {
            background-image: url(img/camera.svg);
        }

        #move-cam-tools.active {
            background-image: url(img/camera-active.svg);
        }

        #add-building-tools {
            background-image: url(img/plus.svg);
            background-size: 60%;
        }

        #add-building-tools.active {
            background-image: url(img/plus-active.svg);
        }

        #grid-tools {
            background-image: url(img/grid.svg);
            background-size: 80%;
        }

        #grid-tools.active {
            background-image: url(img/grid-active.svg);
        }

        #layers-tools {
            background-image: url(img/layers.svg);
            background-size: 80%;
        }

        #layers-tools.active {
            background-image: url(img/layers-active.svg);
        }
    </style>
</head>

<body>
    <div id="city-holder">

        <div id="city">
            <div id="city-buildings"></div>
            <div id="grid-container">
                <div id="grid" style="left: 50%; top: 50%;"></div>
            </div>
        </div>
        <div id="tools" class="menu">
            <div id="move-cam-tools" class="tool-btn"></div>
            <div id="edit-building-tools" class="tool-btn"></div>
            <div id="layers-tools" class="tool-btn"></div>
            <div id="grid-tools" class="tool-btn"></div>
            <div id="close-tools" class="tool-btn"></div>
        </div>
    </div>
    <script>
        const Layer = {
            GROUND: 'ground',
            ROAD: 'road',
            BUILDINGS: 'buildings',
        }
        const gridSize = 100;
        const cityHolder = document.getElementById("city-holder");
        const cityContainer = document.getElementById("city");
        const cityBuildings = document.getElementById("city-buildings");
        const tools = document.getElementById("tools");
        const closeTools = document.getElementById("close-tools");
        const editBuildingTools = document.getElementById("edit-building-tools");
        const moveCamTools = document.getElementById("move-cam-tools");
        const addBuildingTools = document.getElementById("add-building-tools");
        const gridTools = document.getElementById("grid-tools");
        const layersTools = document.getElementById("layers-tools");


        cityContainer.style.width = `${gridSize * 100}px`;
        cityContainer.style.height = `${gridSize * 100}px`;

        const tileWidth = 99;
        const tileHeight = 49.5;
        const maxScale = 1;
        const minScale = 0.2;
        const scaleStep = 0.1;
        let showGrid = false;
        let canCamChange = false;
        let canAddBuilding = false;
        let canBuildingChange = false;
        const layers = [Layer.GROUND, Layer.ROAD, Layer.BUILDINGS];

        let isDragging = false;
        let isPanning = false;
        let scale = 0.5;
        let worldX = 0;
        let worldY = 0;
        let startPan = null;

        const cityRect = cityContainer.getBoundingClientRect();

        let buildings = [];

        function initCity() {
            buildings = [
                { id: 1, x: 0, y: 0, w: 4, h: 4, image: 'img/obj_cit_004_06.png' },
                { id: 2, x: -5, y: -5, w: 2, h: 2, image: 'img/obj_cit_004_06.png' },
                { id: 3, x: 5, y: 5, w: 2, h: 2, image: 'img/obj_cit_004_07.png' },
                { id: 4, x: 8, y: -2, w: 10, h: 10, image: 'img/obj_cit_004_07.png' },
            ];
            renderBuildings();
        }



        function getPointerPosition(e) {
            if (e.touches && e.touches.length > 0) {
                return { x: e.touches[0].clientX, y: e.touches[0].clientY };
            }
            return { x: e.clientX, y: e.clientY };
        }

        function gridToScreen(x, y) {
            return {
                left: (x - y) * (tileWidth / 2) + cityRect.width / 2,
                top: (x + y) * (tileHeight / 2) + cityRect.height / 2,
            };
        }

        function screenToGrid(left, top) {
            const centerX = left - cityRect.width / 2;
            const centerY = top - cityRect.height / 2;
            const x = (centerY / (tileHeight / 2) + centerX / (tileWidth / 2)) / 2;
            const y = (centerY / (tileHeight / 2) - centerX / (tileWidth / 2)) / 2;
            return {
                x: Math.round(x),
                y: Math.round(y)
            };
        }

        function isOccupied(x, y, w, h, excludeId = null) {
            return buildings.some(b => {
                if (b.id === excludeId) return false;
                return !(x + w <= b.x || x >= b.x + b.w || y + h <= b.y || y >= b.y + b.h);
            });
        }

        function isOutOfBounds(x, y, w, h) {
            const min = -Math.round(gridSize / 2);
            const max = Math.round(gridSize / 2) + 1;
            return x <= min || y <= min || x + w > max || y + h > max;
        }

        function renderBuildings() {
            cityBuildings.innerHTML = "";
            buildings.forEach(b => {
                const { left, top } = gridToScreen(b.x, b.y);
                const { top: centerTop } = gridToScreen(b.x + (b.w - 1) / 2, b.y + (b.h - 1) / 2);

                const buildingElement = document.createElement("div");
                buildingElement.className = "building";

                buildingElement.style.width = `${tileWidth * b.w}px`;
                buildingElement.style.height = `${tileWidth * b.h}px`;
                buildingElement.style.transform = `translate(${left}px, ${top + tileHeight * (b.h - 1)}px) translate(-50%, -100%)`;
                buildingElement.style.zIndex = Math.round(100000 + centerTop);
                buildingElement.dataset.id = b.id;

                const imageElement = document.createElement("div");
                imageElement.className = "building-image";
                imageElement.style.backgroundImage = `url(${b.image})`;

                const baseElement = document.createElement("div");
                baseElement.className = "building-base";
                baseElement.style.width = `${tileWidth * b.w}px`;
                baseElement.style.height = `${tileWidth * b.h}px`;

                addDragListeners(buildingElement, baseElement);

                buildingElement.appendChild(baseElement);
                buildingElement.appendChild(imageElement);
                cityBuildings.appendChild(buildingElement);
            });
        }

        function updateGrid() {
            const gridContainer = document.getElementById("grid-container");
            const gridElement = document.getElementById("grid");
            gridContainer.style.width = `${gridSize * 100}px`;
            gridContainer.style.height = `${gridSize * 100}px`;
            gridContainer.style.display = showGrid ? 'block' : 'none';

            gridElement.style.width = `${gridSize * 100}px`;
            gridElement.style.height = `${gridSize * 100}px`;
        }

        function updateTransform() {
            cityContainer.style.transform = `translate(${-50 + worldX * 100}%, ${-50 + worldY * 100}%) scale(${scale})`;
        }

        function addDragListeners(el, baseEl) {
            let start, offset, building = buildings.find(b => b.id == el.dataset.id);

            const onMove = (e) => {
                if (!isDragging) return;
                const pos = getPointerPosition(e);
                const dx = (pos.x - start.x) / scale;
                const dy = (pos.y - start.y) / scale;
                el.style.transform = `translate(${offset.x + dx}px, ${offset.y + dy + tileHeight * (building.h - 1)}px) translate(-50%, -100%)`;
            };

            const onUp = (e) => {
                if (!isDragging) return;
                isDragging = false;

                const pos = getPointerPosition(e);
                const finalX = offset.x + (pos.x - start.x) / scale;
                const finalY = offset.y + (pos.y - start.y) / scale;

                const { x, y } = screenToGrid(finalX, finalY);
                const collision = isOccupied(x, y, building.w, building.h, building.id) || isOutOfBounds(x, y, building.w, building.h);
                if (!collision) {
                    building.x = x;
                    building.y = y;
                }

                el.classList.remove("dragging");
                renderBuildings();
                removeMoveUpListeners();
            };

            const addMoveUpListeners = () => {
                window.addEventListener("pointermove", onMove);
                window.addEventListener("pointerup", onUp);
                window.addEventListener("touchmove", onMove, { passive: false });
                window.addEventListener("touchend", onUp);
            };

            const removeMoveUpListeners = () => {
                window.removeEventListener("pointermove", onMove);
                window.removeEventListener("pointerup", onUp);
                window.removeEventListener("touchmove", onMove);
                window.removeEventListener("touchend", onUp);
            };

            const onDown = (e) => {
                if (!canBuildingChange) {
                    return;
                }
                e.preventDefault();
                isDragging = true;
                const pos = getPointerPosition(e);
                start = { x: pos.x, y: pos.y };
                const { left, top } = gridToScreen(building.x, building.y);
                offset = { x: left, y: top };
                el.classList.add("dragging");
                el.style.zIndex = "9999999";
                addMoveUpListeners();
            };

            baseEl.addEventListener("pointerdown", onDown);
            baseEl.addEventListener("touchstart", onDown, { passive: false });
        }

        function setupPan() {
            cityHolder.addEventListener("wheel", (e) => {
                if (!canCamChange) {
                    return;
                }
                e.preventDefault();
                const delta = e.deltaY > 0 ? -1 : 1;
                scale = Math.min(maxScale, Math.max(minScale, scale + delta * scaleStep));
                updateTransform();
            });

            const onPanMove = (e) => {
                if (!isPanning) return;
                const pos = getPointerPosition(e);
                worldX = (pos.x - startPan.x) / cityRect.width;
                worldY = (pos.y - startPan.y) / cityRect.height;
                updateTransform();
            };

            const onPanEnd = () => {
                isPanning = false;
                cityHolder.classList.remove("grabbing");
                window.removeEventListener("pointermove", onPanMove);
                window.removeEventListener("pointerup", onPanEnd);
                window.removeEventListener("touchmove", onPanMove);
                window.removeEventListener("touchend", onPanEnd);
            };

            const onPanStart = (e) => {
                if (isDragging || !canCamChange) return;
                const pos = getPointerPosition(e);
                isPanning = true;
                startPan = {
                    x: pos.x - worldX * cityRect.width,
                    y: pos.y - worldY * cityRect.height
                };
                cityHolder.classList.add("grabbing");

                window.addEventListener("pointermove", onPanMove);
                window.addEventListener("pointerup", onPanEnd);
                window.addEventListener("touchmove", onPanMove, { passive: false });
                window.addEventListener("touchend", onPanEnd);
            };

            cityHolder.addEventListener("pointerdown", onPanStart);
            cityHolder.addEventListener("touchstart", onPanStart, { passive: false });
        }

        tools.addEventListener("click", (e) => {
            if (!tools.classList.contains('expanded')) {
                tools.classList.add('expanded');
            }
        });
        closeTools.addEventListener("click", (e) => {
            e.stopPropagation();
            if (tools.classList.contains('expanded')) {
                tools.classList.remove('expanded');
            }
        });
        editBuildingTools.addEventListener("click", (e) => {
            e.stopPropagation();
            const enabled = editBuildingTools.classList.contains('active')
            editBuildingTools.classList.toggle('active');
            canBuildingChange = !enabled;
        });
        moveCamTools.addEventListener("click", (e) => {
            e.stopPropagation();
            const enabled = moveCamTools.classList.contains('active')
            moveCamTools.classList.toggle('active');
            canCamChange = !enabled;
        });
        addBuildingTools.addEventListener("click", (e) => {
            e.stopPropagation();
            const enabled = addBuildingTools.classList.contains('active')
            addBuildingTools.classList.toggle('active');
            canAddBuilding = !enabled;
        });
        gridTools.addEventListener("click", (e) => {
            e.stopPropagation();
            const enabled = gridTools.classList.contains('active')
            gridTools.classList.toggle('active');
            showGrid = !enabled;
            updateGrid();
        });
        layersTools.addEventListener("click", (e) => {
            e.stopPropagation();
            const enabled = layersTools.classList.contains('active')
            layersTools.classList.toggle('active');
        });

        renderBuildings();
        updateGrid();
        updateTransform();
        setupPan();
        initCity();
    </script>


</body>

</html>